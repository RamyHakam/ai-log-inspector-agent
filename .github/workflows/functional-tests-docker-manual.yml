name: Functional Tests with Ollama Docker (Manual)

# This workflow uses Ollama v0.11.10+ to ensure compatibility with Symfony AI Platform
# Symfony AI Platform requires Ollama >= v0.6.4 for proper /api/show capabilities detection
# See: https://github.com/ollama/ollama/commit/e172f095ba4af2c98d7744ce4ffcf4cd3a8e123c

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  functional-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, json, tokenizer
    
    - name: Install Composer dependencies
      run: |
        echo "Installing Composer dependencies..."
        composer install --prefer-dist --no-progress || {
          echo "‚ö†Ô∏è  Composer install failed, trying composer update..."
          composer update --prefer-dist --no-progress
        }
    
    # Start Ollama container with latest version for compatibility
    - name: Start Ollama container
      run: |
        echo "Starting Ollama container with latest version (v0.11.10) for /api/show capabilities support..."
        docker run -d \
          --name ollama-test \
          -p 11434:11434 \
          -e OLLAMA_HOST=0.0.0.0:11434 \
          -e OLLAMA_CONTEXT_LENGTH=4096 \
          -e OLLAMA_KEEP_ALIVE=5m0s \
          ollama/ollama:0.11.10
        
        echo "Waiting for container to be ready..."
        sleep 15
        
        # Check container status
        docker ps
        docker logs ollama-test
    
    # Wait for Ollama service to be ready with better error handling
    - name: Wait for Ollama service
      run: |
        echo "Waiting for Ollama API to be ready..."
        for i in {1..30}; do
          if curl -f http://localhost:11434/api/version 2>/dev/null; then
            echo "‚úÖ Ollama API is ready!"
            OLLAMA_VERSION=$(curl -s http://localhost:11434/api/version | jq -r '.version // "unknown"')
            echo "Ollama version: $OLLAMA_VERSION"
            curl -s http://localhost:11434/api/version | jq .
            break
          fi
          echo "‚è≥ Attempt $i/30: Ollama not ready yet, waiting 10 seconds..."
          if [ $i -eq 15 ]; then
            echo "üîç Mid-check: Container status and logs"
            docker ps -a --filter name=ollama-test
            docker logs ollama-test --tail 20
          fi
          sleep 10
          if [ $i -eq 30 ]; then
            echo "‚ùå ERROR: Ollama service failed to start after 5 minutes"
            echo "Final container status:"
            docker ps -a --filter name=ollama-test
            echo "Final container logs:"
            docker logs ollama-test
            exit 1
          fi
        done
    
    # Pull model into the Ollama container
    - name: Pull Ollama model
      run: |
        echo "Pulling llama3.2:1b model for consistency with tests..."
        docker exec ollama-test ollama pull llama3.2:1b
        
        echo "Verifying model was pulled..."
        docker exec ollama-test ollama list
    
    # Verify Ollama version for compatibility
    - name: Verify Ollama version
      run: |
        echo "Verifying Ollama version for Symfony AI Platform compatibility..."
        OLLAMA_VERSION=$(curl -s http://localhost:11434/api/version | jq -r '.version // "unknown"')
        echo "Current Ollama version: $OLLAMA_VERSION"
        
        # Extract version number for comparison
        VERSION_NUM=$(echo "$OLLAMA_VERSION" | sed 's/v//' | cut -d. -f1-3)
        echo "Version number: $VERSION_NUM"
        
        # Check if version is >= 0.6.4 (when capabilities were added)
        if printf '%s\n%s\n' "0.6.4" "$VERSION_NUM" | sort -V -C; then
          echo "‚úÖ Ollama version $OLLAMA_VERSION supports /api/show capabilities - compatible with Symfony AI"
        else
          echo "‚ùå Ollama version $OLLAMA_VERSION may not support capabilities field"
          echo "‚ö†Ô∏è  Symfony AI Platform requires Ollama >= v0.6.4 for proper capabilities detection"
        fi
    
    # Test Ollama setup
    - name: Test Ollama setup
      run: |
        echo "Testing Ollama with llama3.2:1b model..."
        
        # Test /api/show endpoint first (this is where the compatibility issue occurs)
        echo "Testing /api/show endpoint for capabilities support..."
        echo "Request: POST /api/show with body: {\"model\":\"llama3.2:1b\"}"
        HTTP_CODE=$(curl -w "%{http_code}" -s -X POST http://localhost:11434/api/show \
          -H "Content-Type: application/json" \
          -d '{"model":"llama3.2:1b"}' -o /tmp/show_response.json)
        echo "HTTP response code: $HTTP_CODE"
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ /api/show successful"
          CAPABILITIES=$(cat /tmp/show_response.json | jq -r '.capabilities // null')
          if [ "$CAPABILITIES" != "null" ]; then
            echo "‚úÖ Capabilities field found: $CAPABILITIES"
          else
            echo "‚ö†Ô∏è  No capabilities field - this may cause Symfony AI Platform issues"
          fi
          cat /tmp/show_response.json | jq '.capabilities // "No capabilities found"'
        else
          echo "‚ùå /api/show failed with HTTP $HTTP_CODE"
          echo "Response body:"
          cat /tmp/show_response.json
          echo "‚ùå This will cause Symfony AI Platform to fail!"
        fi
        
        # Test generation
        echo "Testing generation..."
        timeout 120 curl -X POST http://localhost:11434/api/generate \
          -H "Content-Type: application/json" \
          -d "{
            \"model\": \"llama3.2:1b\", 
            \"prompt\": \"Test\", 
            \"stream\": false,
            \"options\": {
              \"num_predict\": 5,
              \"temperature\": 0.1
            }
          }" | jq -r '.response // "No response received"'
    
    # Run functional tests
    - name: Run Functional Tests
      timeout-minutes: 10
      env:
        OLLAMA_URL: http://localhost:11434
        OLLAMA_MODEL: llama3.2:1b  # Will be auto-detected in the test
      run: |
        echo "Running functional tests (max 10 minutes)..."
        timeout 600 vendor/bin/phpunit test/Functional/ --testdox || {
          echo "Tests timed out or failed"
          exit 1
        }
    
    # Cleanup
    - name: Cleanup Ollama container
      if: always()
      run: |
        echo "Cleaning up Ollama container..."
        docker stop ollama-test || true
        docker rm ollama-test || true
